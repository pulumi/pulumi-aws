#!/usr/bin/env bash
set -euo pipefail

#MISE description="Run focused acceptance/integration tests"
#USAGE flag "--dir <path>" help="Directory containing go tests" default="examples"
#USAGE flag "--pkg <pattern>" help="Package pattern to pass to go test" default="./..."
#USAGE flag "--run <regex>" help="Regex filter passed to go test -run"
#USAGE flag "--tags <tags>" help="Go build tags" default="all"
#USAGE flag "--timeout <duration>" help="go test timeout" default="45m"
#USAGE flag "--count <n>" help="go test -count" default="1"
#USAGE flag "--args <args>" help="Additional go test args"
#USAGE complete "dir" run="fd '' examples --type d"

mise run provider:no-deps

cd "${usage_dir}"

args=()
if [[ -n "${usage_run:-}" ]]; then
  args+=("-run" "${usage_run}")
fi

if [[ -n "${usage_args:-}" ]]; then
  # shellcheck disable=SC2206
  args+=(${usage_args})
fi

go test -v \
  -parallel "${TESTPARALLELISM:-10}" \
  -tags "${usage_tags}" \
  -timeout "${usage_timeout}" \
  -count "${usage_count}" \
  "${args[@]}" \
  "${usage_pkg}"
