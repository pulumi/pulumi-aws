# WARNING: This file is autogenerated - changes will be overwritten when regenerated by https://github.com/pulumi/ci-mgmt

name: Upgrade Java
on:
  workflow_dispatch:
    inputs:
      version:
        description: |
          The version of pulumi/pulumi-java to upgrade to, without the 'v' prefix
        required: true
        type: string
      upgradeProviderVersion:
        description: |
          Version of upgrade-provider to use. This must be a valid git reference in the pulumi/upgrade-provider repo. Defaults to "main"

          See https://go.dev/ref/mod#versions for valid versions. E.g. "v0.1.0", "main", "da25dec".
        default: main
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  upgrade_java:
    name: upgrade-java
    runs-on: ubuntu-latest
    steps:

      - name: Checkout Repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          # Persist credentials so upgrade-provider can push a new branch.
          persist-credentials: true      
      - id: esc-secrets
        name: Map environment to ESC outputs
        uses: ./.github/actions/esc-action

      - name: Setup tools
        uses: ./.github/actions/setup-tools
        with:
          tools: pulumictl, pulumicli, go

      - name: Install upgrade-provider
        run: go install github.com/pulumi/upgrade-provider@${{ inputs.upgradeProviderVersion || 'main' }}
        shell: bash

      - name: "Set up git identity"
        run: |
          git config --global user.name 'bot@pulumi.com'
          git config --global user.email 'bot@pulumi.com'
        shell: bash

      - name: Upgrade Java
        shell: bash
        id: upgrade_provider
        env:
          V: ${{inputs.version}}
          REPO: ${{github.repository}}
          # upgrade-provider calls into gh CLI tool to open PRs that uses GH_TOKEN env var, which is not obivous.
          # setting this correctly makes sure the PR has the correct owner and permissions work as expected.
          GH_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_TOKEN || steps.esc-secrets.outputs.PULUMI_BOT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          upgrade-provider "$REPO" --kind=java --java-version="$V"
